name: Daily Content Generation

on:
  schedule:
    # Runs daily at 7:00 AM UTC
    - cron: '0 7 * * *'
  # Allows manual trigger
  workflow_dispatch:

jobs:
  generate-content:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate content
      id: generate
      env:
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "üöÄ Iniciando gera√ß√£o de conte√∫do..."
        npm run content:generate
        
        # Contar novos arquivos gerados
        NEW_FILES=$(find src/content -name "*.mdx" -newer .git/FETCH_HEAD 2>/dev/null | wc -l || echo "0")
        echo "new_files=$NEW_FILES" >> $GITHUB_OUTPUT
        
        if [ $NEW_FILES -gt 0 ]; then
          echo "‚úÖ Gerados $NEW_FILES novos artigos"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "‚ÑπÔ∏è Nenhum artigo novo gerado"
          echo "success=false" >> $GITHUB_OUTPUT
        fi

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add src/content/
        git commit -m "ü§ñ Daily content update - $(date +'%Y-%m-%d')"
        git push

    - name: Run health check
      id: health
      run: |
        echo "üîç Executando verifica√ß√£o de sa√∫de..."
        npm run health:check
        echo "health_passed=true" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: üì± Notify Slack - Success
      if: success() && steps.generate.outputs.success == 'true'
      run: |
        if [ ! -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "channel": "#ireland-ednews",
              "username": "Ireland EdNews Bot",
              "icon_emoji": ":ireland:",
              "attachments": [{
                "color": "good",
                "title": "‚úÖ Gera√ß√£o de Conte√∫do Di√°ria Conclu√≠da!",
                "fields": [
                  {
                    "title": "üìä Novos Artigos",
                    "value": "${{ steps.generate.outputs.new_files }}",
                    "short": true
                  },
                  {
                    "title": "üìÖ Data",
                    "value": "'$(date +'%d/%m/%Y √†s %H:%M UTC')'",
                    "short": true
                  },
                  {
                    "title": "üîó Ver Site",
                    "value": "<https://ireland-ednews.vercel.app|ireland-ednews.vercel.app>",
                    "short": false
                  }
                ],
                "footer": "Ireland EdNews",
                "ts": '$(date +%s)'
              }]
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        fi

    - name: üì± Notify Slack - Failure
      if: failure()
      run: |
        if [ ! -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "channel": "#ireland-ednews",
              "username": "Ireland EdNews Bot",
              "icon_emoji": ":warning:",
              "attachments": [{
                "color": "danger",
                "title": "‚ùå Falha na Gera√ß√£o de Conte√∫do",
                "fields": [
                  {
                    "title": "üìÖ Data",
                    "value": "'$(date +'%d/%m/%Y √†s %H:%M UTC')'",
                    "short": true
                  },
                  {
                    "title": "üîß A√ß√£o Necess√°ria",
                    "value": "Verificar logs e configura√ß√µes",
                    "short": true
                  },
                  {
                    "title": "üîó Ver Logs",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Ver detalhes do erro>",
                    "short": false
                  }
                ],
                "footer": "Ireland EdNews",
                "ts": '$(date +%s)'
              }]
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        fi

    - name: üì± Notify Slack - No Content
      if: success() && steps.generate.outputs.success == 'false'
      run: |
        if [ ! -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "channel": "#ireland-ednews",
              "username": "Ireland EdNews Bot",
              "icon_emoji": ":information_source:",
              "attachments": [{
                "color": "warning",
                "title": "‚ÑπÔ∏è Nenhum Conte√∫do Novo Hoje",
                "fields": [
                  {
                    "title": "üìÖ Data",
                    "value": "'$(date +'%d/%m/%Y √†s %H:%M UTC')'",
                    "short": true
                  },
                  {
                    "title": "üîç Poss√≠veis Causas",
                    "value": "‚Ä¢ Sem not√≠cias relevantes\n‚Ä¢ Limite de API atingido\n‚Ä¢ Filtros restritivos",
                    "short": false
                  }
                ],
                "footer": "Ireland EdNews",
                "ts": '$(date +%s)'
              }]
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        fi
